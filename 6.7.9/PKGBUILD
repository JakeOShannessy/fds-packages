# Maintainer: Jake O'Shannessy <joshannessy@smokecloud.io>
pkgname=fds-6.7.9
pkgver=6.7.9
pkgrel=1
epoch=
pkgdesc="Fire Dynamics Simulator (FDS) from NIST."
arch=('x86_64')
url="https://pages.nist.gov/fds-smv/"
license=('PublicDomain')
groups=()
depends=()
makedepends=('patch')
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=(!strip)
install=
changelog=
commit=ec52dee4274fcf994d358c8b0f883eec8f67e041
repo=fds
source=("https://github.com/firemodels/${repo}/archive/${commit}.zip" "../fds.sh" "version.patch")
noextract=()
sha1sums=('SKIP' 'SKIP' 'SKIP')
validpgpkeys=()

prepare() {
        patch --strip=1 --input="${srcdir}/version.patch" --directory ${repo}-${commit}
        echo "prepare done"
}

build() {
        source /opt/intel/oneapi/setvars.sh
        cd ${repo}-${commit}/Build/impi_intel_linux
        export full_commit=%{commit}
        export commit=${full_commit:0:9}
        ./make_fds.sh
        cp fds_impi_intel_linux ../../../fds-exec
}

check() {
        echo "done"
}

package() {
        FINAL_INSTALL_DIR=/usr/bin
        INSTALLDIR=$pkgdir$FINAL_INSTALL_DIR
        mkdir -p $INSTALLDIR
        {
                echo "#!/bin/sh"
                echo "PROGRAM_VERSION=${pkgver}"
                echo "FDS_EXEC=fds-exec-${pkgver}"
                cat fds.sh
        } > fds-script
        install fds-script "${INSTALLDIR}"/fds-"${pkgver}"
        install fds-exec "${INSTALLDIR}"/fds-exec-"${pkgver}"
}
