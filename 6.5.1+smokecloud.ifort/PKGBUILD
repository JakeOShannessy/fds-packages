# Maintainer: Your Name <youremail@domain.com>
pkgname=fds-6.5.1+smokecloud.ifort
pkgver=6.5.1
pkgrel=1
epoch=
pkgdesc="Fire Dynamics Simulator (FDS) from NIST."
arch=('x86_64')
url="https://pages.nist.gov/fds-smv/"
license=('PublicDomain')
groups=()
depends=()
makedepends=()
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=(!strip)
install=
changelog=
source=("git+https://github.com/firemodels/fds-smv_deprecated#commit=9ea0a920d7816dba678888d69ff6b4393f2a850a" "backports.patch")
noextract=()
sha1sums=('SKIP' '7c75a76ec455e31fae9f74869fdcb5bc95fcddc7')
validpgpkeys=()

prepare() {
        patch --forward --strip=1 --input="${srcdir}/backports.patch" --directory fds-smv_deprecated/FDS_Source --strip 2
        echo "prepare done"
}

build() {
        source /opt/intel/oneapi/setvars.sh
        cd fds-smv_deprecated/FDS_Compilation/mpi_intel_linux_64
        platform=intel64
        dir=`pwd`
        target=${dir##*/}
        make -j4 FCOMPL=mpiifort FOPENMPFLAGS="-qopenmp -qopenmp-link static -liomp5" VPATH="../../FDS_Source" -f ../makefile $target
}

check() {
        echo "done"
}

package() {
        FINAL_INSTALL_DIR=/opt/FDS/$pkgver+smokecloud.ifort
        cd fds-smv_deprecated/FDS_Compilation/mpi_intel_linux_64
        INSTALLDIR=$pkgdir$FINAL_INSTALL_DIR
        mkdir -p $INSTALLDIR/bin
        mv fds_mpi_intel_linux_64 $INSTALLDIR/bin/fds-exec

        echo "#!/bin/sh" > ${INSTALLDIR}/bin/fds
        echo "source /opt/intel/oneapi/setvars.sh" >> ${INSTALLDIR}/bin/fds
        echo "ulimit -s unlimited" >> ${INSTALLDIR}/bin/fds
        echo "exec mpiexec -np \$1 ${FINAL_INSTALL_DIR}/bin/fds-exec \"\${@:2}\"" >> ${INSTALLDIR}/bin/fds
        chmod 755 ${INSTALLDIR}/bin/fds
}
