# Maintainer: Jake O'Shannessy <joshannessy@smokecloud.io>
pkgname=fds-6.1.2
pkgver=6.1.2
pkgrel=1
epoch=
pkgdesc="Fire Dynamics Simulator (FDS) from NIST."
arch=('x86_64')
url="https://pages.nist.gov/fds-smv/"
license=('PublicDomain')
groups=()
depends=()
makedepends=('patch')
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=(!strip)
install=
changelog=
commit=689afcd4c59504cc031b860fd081d935a2a3351f
repo=fds-smv_deprecated
source=("https://github.com/firemodels/${repo}/archive/${commit}.zip" "backports.patch")
noextract=()
sha1sums=('SKIP' 'a8049e56e8e0f9bf127df0838dd3f9cad56a0fe1')
validpgpkeys=()

prepare() {
        patch --strip=1 --input="${srcdir}/backports.patch" --directory ${repo}-${commit}
        echo "prepare done"
}

build() {
        source /opt/intel/oneapi/setvars.sh
        cd ${repo}-${commit}/FDS_Compilation/impi_intel_linux_64
        dir=$(pwd)
        target=${dir##*/}
        make FCOMPL=mpiifort  FOPENMPFLAGS="-qopenmp -qopenmp-link static -liomp5" -j4 VPATH="../../FDS_Source" -f ../makefile $target
}

check() {
        echo "done"
}

package() {
        FINAL_INSTALL_DIR=/usr/bin
        cd ${repo}-${commit}/FDS_Compilation/impi_intel_linux_64
        INSTALLDIR=$pkgdir$FINAL_INSTALL_DIR
        mkdir -p $INSTALLDIR
        install fds_impi_intel_linux_64 $INSTALLDIR/fds-exec-${pkgver}

        echo "#!/bin/sh" > ${INSTALLDIR}/fds-${pkgver}
        echo "source /opt/intel/oneapi/setvars.sh" >> ${INSTALLDIR}/fds-${pkgver}
        echo "ulimit -s unlimited" >> ${INSTALLDIR}/fds-${pkgver}
        echo "exec mpiexec -np \$1 ${FINAL_INSTALL_DIR}/fds-exec-${pkgver} \"\${@:2}\"" >> ${INSTALLDIR}/fds-${pkgver}
}
